<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug Completo - Sistema Asistencia Tenis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #10b981;
        }
        .hypothesis {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background-color: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #059669;
        }
        button.debug {
            background-color: #dc3545;
        }
        button.debug:hover {
            background-color: #c82333;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background-color: #dcfce7;
            border: 1px solid #10b981;
            color: #166534;
        }
        .error {
            background-color: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .info {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        .url-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 12px;
        }
        .step {
            background-color: #f8f9fa;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Completo - Sistema Asistencia Tenis</h1>
        
        <div class="hypothesis">
            <h4>üßê HIP√ìTESIS PRINCIPALES:</h4>
            <ul>
                <li><strong>H1:</strong> URL incorrecta en el proxy (diferentes versiones del script)</li>
                <li><strong>H2:</strong> Script no completamente desplegado o versi√≥n antigua</li>
                <li><strong>H3:</strong> Funci√≥n testConnection no existe en el script actual</li>
                <li><strong>H4:</strong> Problema en el formato de par√°metros entre proxy y script</li>
            </ul>
        </div>

        <!-- PASO 1: Verificar URLs -->
        <div class="test-section">
            <h3>üîç PASO 1: Verificar URLs y Configuraci√≥n</h3>
            <div class="step">
                <strong>Objetivo:</strong> Confirmar qu√© URL est√° usando realmente el proxy vs tu script.
            </div>
            
            <label><strong>URL del proxy actual:</strong></label>
            <input type="text" class="url-input" readonly 
                   value="https://script.google.com/macros/s/AKfycbzsW2UOJhqv6YcUwqaAp-eWQRj99nab8NpQoB08nUr2sGqjK_LLoq9KxGYVYp0SkDhemQ/exec">
            
            <label><strong>URL de tu Google Apps Script (la que usaste en el test manual):</strong></label>
            <input type="text" id="manual-url" class="url-input" 
                   placeholder="Pega aqu√≠ la URL que usaste en el test manual que S√ç funcion√≥">
            
            <button onclick="compareUrls()" class="debug">üîç Comparar URLs</button>
            <div id="url-comparison"></div>
        </div>

        <!-- PASO 2: Test directo sin proxy -->
        <div class="test-section">
            <h3>üß™ PASO 2: Test Directo (Sin Proxy)</h3>
            <div class="step">
                <strong>Objetivo:</strong> Probar directamente tu Google Apps Script para ver qu√© funciones tiene.
            </div>
            
            <button onclick="testDirectScript('getGroups')" class="debug">üìö Test getGroups Directo</button>
            <button onclick="testDirectScript('testConnection')" class="debug">üîó Test testConnection Directo</button>
            <button onclick="testDirectScript('getSpreadsheetInfo')" class="debug">üìä Test getSpreadsheetInfo Directo</button>
            <div id="direct-test-result"></div>
        </div>

        <!-- PASO 3: Inspeccionar el script actual -->
        <div class="test-section">
            <h3>üîé PASO 3: Inspeccionar Funciones Disponibles</h3>
            <div class="step">
                <strong>Objetivo:</strong> Ver qu√© funciones est√°n realmente disponibles en tu script.
            </div>
            
            <button onclick="listAvailableFunctions()" class="debug">üìã Listar Funciones Disponibles</button>
            <button onclick="testRawGet()" class="debug">üîÑ Test GET Sin Par√°metros</button>
            <button onclick="testRawPost()" class="debug">üîÑ Test POST Sin Par√°metros</button>
            <div id="inspection-result"></div>
        </div>

        <!-- PASO 4: Test espec√≠ficos por hip√≥tesis -->
        <div class="test-section">
            <h3>üéØ PASO 4: Tests por Hip√≥tesis</h3>
            
            <div class="step">
                <strong>H1: Test con URL correcta</strong>
                <button onclick="testWithCorrectUrl()" class="debug">üîß Test con URL Manual</button>
                <div id="h1-result"></div>
            </div>
            
            <div class="step">
                <strong>H2: Test acciones b√°sicas que sabemos que funcionan</strong>
                <button onclick="testKnownWorkingAction()" class="debug">‚úÖ Test getGroups (sabemos que funciona)</button>
                <div id="h2-result"></div>
            </div>
            
            <div class="step">
                <strong>H3: Test acciones que podr√≠an no existir</strong>
                <button onclick="testUnknownActions()" class="debug">‚ùì Test Acciones Desconocidas</button>
                <div id="h3-result"></div>
            </div>
        </div>

        <!-- PASO 5: Diagn√≥stico completo -->
        <div class="test-section">
            <h3>üìã PASO 5: Diagn√≥stico Completo</h3>
            <button onclick="runFullDiagnosis()" class="debug">ü©∫ Ejecutar Diagn√≥stico Completo</button>
            <div id="diagnosis-result"></div>
        </div>

        <!-- Resumen y siguiente paso -->
        <div class="test-section">
            <h3>üìù CONCLUSIONES Y SIGUIENTE PASO</h3>
            <div id="conclusions">
                <p>Ejecuta las pruebas de arriba para obtener el diagn√≥stico...</p>
            </div>
        </div>
    </div>

    <script>
        const PROXY_URL = 'https://asistenciastmc.netlify.app/api/sheets-proxy';
        const CURRENT_PROXY_SCRIPT = 'https://script.google.com/macros/s/AKfycbzsW2UOJhqv6YcUwqaAp-eWQRj99nab8NpQoB08nUr2sGqjK_LLoq9KxGYVYp0SkDhemQ/exec';

        // PASO 1: Comparar URLs
        function compareUrls() {
            const manualUrl = document.getElementById('manual-url').value.trim();
            const result = document.getElementById('url-comparison');
            
            if (!manualUrl) {
                result.innerHTML = '<div class="result error">‚ùå Por favor ingresa la URL de tu script manual</div>';
                return;
            }
            
            const proxyId = CURRENT_PROXY_SCRIPT.match(/\/s\/([^\/]+)\//)[1];
            const manualId = manualUrl.match(/\/s\/([^\/]+)\//)?.[1];
            
            let html = '<div class="result info">';
            html += '<strong>COMPARACI√ìN DE URLs:</strong><br><br>';
            html += `<strong>ID del proxy:</strong> ${proxyId}<br>`;
            html += `<strong>ID manual:</strong> ${manualId || 'No v√°lido'}<br><br>`;
            
            if (proxyId === manualId) {
                html += '‚úÖ <strong>LAS URLs SON IGUALES</strong> - El problema no es la URL<br>';
                html += 'üîç <strong>Hip√≥tesis H1 DESCARTADA</strong>';
            } else {
                html += '‚ùå <strong>LAS URLs SON DIFERENTES</strong> - AQU√ç EST√Å EL PROBLEMA<br>';
                html += 'üéØ <strong>Hip√≥tesis H1 CONFIRMADA</strong><br>';
                html += 'üí° <strong>Soluci√≥n:</strong> Actualizar el proxy con la URL correcta';
            }
            html += '</div>';
            
            result.innerHTML = html;
        }

        // PASO 2: Test directo
        async function testDirectScript(action) {
            const manualUrl = document.getElementById('manual-url').value.trim();
            const result = document.getElementById('direct-test-result');
            
            if (!manualUrl) {
                result.innerHTML = '<div class="result error">‚ùå Primero ingresa tu URL manual en el Paso 1</div>';
                return;
            }
            
            result.innerHTML = '<div class="result warning">‚è≥ Probando directamente tu script...</div>';
            
            try {
                const testUrl = `${manualUrl}?action=${action}`;
                console.log('üîç Test directo:', testUrl);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'no-cors' // Para evitar CORS, pero no podremos leer la respuesta
                });
                
                result.innerHTML = `<div class="result warning">
                    ‚ö†Ô∏è <strong>CORS Bloqueado (esperado)</strong><br>
                    ‚úÖ Pero la petici√≥n se envi√≥ correctamente<br>
                    üîç URL probada: ${testUrl}<br><br>
                    <strong>Si tu script tiene logs, deber√≠as ver la ejecuci√≥n ahora.</strong><br>
                    Ve a <a href="https://script.google.com" target="_blank">script.google.com</a> ‚Üí Tu proyecto ‚Üí Execuciones
                </div>`;
                
            } catch (error) {
                result.innerHTML = `<div class="result error">
                    ‚ùå <strong>Error al enviar petici√≥n:</strong><br>
                    ${error.message}
                </div>`;
            }
        }

        // PASO 3: Inspeccionar funciones
        async function listAvailableFunctions() {
            const result = document.getElementById('inspection-result');
            result.innerHTML = '<div class="result warning">‚è≥ Inspeccionando funciones disponibles...</div>';
            
            const tests = [
                'getGroups',
                'getStudents', 
                'testConnection',
                'getSpreadsheetInfo',
                'saveAttendance',
                'invalidAction'
            ];
            
            let html = '<div class="result info"><strong>RESULTADOS DE INSPECCI√ìN:</strong><br><br>';
            
            for (const action of tests) {
                try {
                    const response = await fetch(`${PROXY_URL}?action=${action}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        html += `‚úÖ <strong>${action}:</strong> FUNCIONA<br>`;
                    } else if (data.error && data.error.includes('no reconocida')) {
                        html += `‚ùå <strong>${action}:</strong> NO EXISTE<br>`;
                    } else {
                        html += `‚ö†Ô∏è <strong>${action}:</strong> EXISTE pero error: ${data.error}<br>`;
                    }
                } catch (error) {
                    html += `üí• <strong>${action}:</strong> ERROR DE RED: ${error.message}<br>`;
                }
            }
            
            html += '</div>';
            result.innerHTML = html;
        }

        async function testRawGet() {
            const result = document.getElementById('inspection-result');
            result.innerHTML = '<div class="result warning">‚è≥ Test GET sin par√°metros...</div>';
            
            try {
                const response = await fetch(PROXY_URL, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                result.innerHTML = `<div class="result info">
                    <strong>GET SIN PAR√ÅMETROS:</strong><br>
                    ${JSON.stringify(data, null, 2)}
                </div>`;
                
            } catch (error) {
                result.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testRawPost() {
            const result = document.getElementById('inspection-result');
            result.innerHTML = '<div class="result warning">‚è≥ Test POST sin par√°metros...</div>';
            
            try {
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                result.innerHTML = `<div class="result info">
                    <strong>POST SIN PAR√ÅMETROS:</strong><br>
                    ${JSON.stringify(data, null, 2)}
                </div>`;
                
            } catch (error) {
                result.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // PASO 4: Tests por hip√≥tesis
        async function testWithCorrectUrl() {
            const manualUrl = document.getElementById('manual-url').value.trim();
            const result = document.getElementById('h1-result');
            
            if (!manualUrl) {
                result.innerHTML = '<div class="result error">‚ùå Primero ingresa tu URL manual</div>';
                return;
            }
            
            result.innerHTML = '<div class="result warning">‚è≥ Simulando proxy con URL correcta...</div>';
            
            // Simular lo que har√≠a el proxy con la URL correcta
            try {
                const response = await fetch(manualUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'testConnection' }),
                    mode: 'no-cors'
                });
                
                result.innerHTML = `<div class="result warning">
                    ‚ö†Ô∏è <strong>CORS Bloqueado (esperado)</strong><br>
                    ‚úÖ Pero la petici√≥n POST se envi√≥ con: { action: 'testConnection' }<br>
                    üîç Si tu script recibe esto, deber√≠a ejecutar testConnection<br><br>
                    <strong>Revisa los logs de ejecuci√≥n en Google Apps Script</strong>
                </div>`;
                
            } catch (error) {
                result.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testKnownWorkingAction() {
            const result = document.getElementById('h2-result');
            result.innerHTML = '<div class="result warning">‚è≥ Probando getGroups que sabemos que funciona...</div>';
            
            try {
                const response = await fetch(`${PROXY_URL}?action=getGroups`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    result.innerHTML = `<div class="result success">
                        ‚úÖ <strong>getGroups FUNCIONA PERFECTAMENTE</strong><br>
                        üìä Retorn√≥ ${data.data.length} grupos<br>
                        üí° <strong>Conclusi√≥n:</strong> El proxy y el script est√°n bien conectados<br>
                        üéØ <strong>El problema es espec√≠fico de ciertas funciones</strong>
                    </div>`;
                } else {
                    result.innerHTML = `<div class="result error">
                        ‚ùå <strong>getGroups fall√≥:</strong><br>
                        ${JSON.stringify(data, null, 2)}
                    </div>`;
                }
                
            } catch (error) {
                result.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testUnknownActions() {
            const result = document.getElementById('h3-result');
            result.innerHTML = '<div class="result warning">‚è≥ Probando acciones que podr√≠an no existir...</div>';
            
            const actionsToTest = [
                'testConnection',
                'getSpreadsheetInfo', 
                'getProfessors',
                'nonExistentAction'
            ];
            
            let html = '<div class="result info"><strong>TEST DE ACCIONES DESCONOCIDAS:</strong><br><br>';
            
            for (const action of actionsToTest) {
                try {
                    const response = await fetch(`${PROXY_URL}?action=${action}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        html += `‚úÖ <strong>${action}:</strong> EXISTE Y FUNCIONA<br>`;
                    } else if (data.error && data.error.includes('no reconocida')) {
                        html += `‚ùå <strong>${action}:</strong> NO IMPLEMENTADA en el script<br>`;
                    } else {
                        html += `‚ö†Ô∏è <strong>${action}:</strong> EXISTE pero error: ${data.error}<br>`;
                    }
                } catch (error) {
                    html += `üí• <strong>${action}:</strong> ERROR: ${error.message}<br>`;
                }
            }
            
            html += '</div>';
            result.innerHTML = html;
        }

        // PASO 5: Diagn√≥stico completo
        async function runFullDiagnosis() {
            const result = document.getElementById('diagnosis-result');
            const conclusions = document.getElementById('conclusions');
            
            result.innerHTML = '<div class="result warning">‚è≥ Ejecutando diagn√≥stico completo...</div>';
            
            const diagnosis = {
                proxy_connectivity: false,
                script_connectivity: false,
                url_match: false,
                basic_functions: [],
                missing_functions: [],
                recommendations: []
            };
            
            // Test 1: Conectividad del proxy
            try {
                const response = await fetch(PROXY_URL);
                diagnosis.proxy_connectivity = true;
            } catch (error) {
                diagnosis.proxy_connectivity = false;
            }
            
            // Test 2: Funci√≥n que sabemos que funciona
            try {
                const response = await fetch(`${PROXY_URL}?action=getGroups`);
                const data = await response.json();
                if (data.success) {
                    diagnosis.script_connectivity = true;
                    diagnosis.basic_functions.push('getGroups');
                }
            } catch (error) {
                diagnosis.script_connectivity = false;
            }
            
            // Test 3: URLs
            const manualUrl = document.getElementById('manual-url').value.trim();
            if (manualUrl) {
                const proxyId = CURRENT_PROXY_SCRIPT.match(/\/s\/([^\/]+)\//)[1];
                const manualId = manualUrl.match(/\/s\/([^\/]+)\//)?.[1];
                diagnosis.url_match = proxyId === manualId;
            }
            
            // Test 4: Funciones espec√≠ficas
            const functionsToTest = ['testConnection', 'getSpreadsheetInfo', 'getProfessors'];
            for (const func of functionsToTest) {
                try {
                    const response = await fetch(`${PROXY_URL}?action=${func}`);
                    const data = await response.json();
                    if (data.success) {
                        diagnosis.basic_functions.push(func);
                    } else if (data.error && data.error.includes('no reconocida')) {
                        diagnosis.missing_functions.push(func);
                    }
                } catch (error) {
                    diagnosis.missing_functions.push(func);
                }
            }
            
            // Generar recomendaciones
            if (!diagnosis.url_match && manualUrl) {
                diagnosis.recommendations.push('üîß CR√çTICO: Actualizar URL en el proxy de Netlify');
            }
            
            if (diagnosis.missing_functions.length > 0) {
                diagnosis.recommendations.push('üìù Agregar funciones faltantes al Google Apps Script');
            }
            
            if (diagnosis.script_connectivity && diagnosis.missing_functions.includes('testConnection')) {
                diagnosis.recommendations.push('‚úÖ El script funciona, solo falta implementar testConnection');
            }
            
            // Mostrar resultados
            let html = '<div class="result info"><strong>ü©∫ DIAGN√ìSTICO COMPLETO:</strong><br><br>';
            html += `üåê <strong>Proxy Netlify:</strong> ${diagnosis.proxy_connectivity ? '‚úÖ Funciona' : '‚ùå Falla'}<br>`;
            html += `üì° <strong>Conexi√≥n Script:</strong> ${diagnosis.script_connectivity ? '‚úÖ Funciona' : '‚ùå Falla'}<br>`;
            html += `üîó <strong>URLs coinciden:</strong> ${diagnosis.url_match ? '‚úÖ S√≠' : '‚ùå No'}<br>`;
            html += `‚úÖ <strong>Funciones que funcionan:</strong> ${diagnosis.basic_functions.join(', ') || 'Ninguna'}<br>`;
            html += `‚ùå <strong>Funciones faltantes:</strong> ${diagnosis.missing_functions.join(', ') || 'Ninguna'}<br><br>`;
            html += '<strong>üéØ RECOMENDACIONES:</strong><br>';
            diagnosis.recommendations.forEach(rec => {
                html += `‚Ä¢ ${rec}<br>`;
            });
            html += '</div>';
            
            result.innerHTML = html;
            
            // Actualizar conclusiones
            let conclusionHtml = '<div class="result success"><strong>üéØ CONCLUSI√ìN PRINCIPAL:</strong><br><br>';
            
            if (!diagnosis.url_match && manualUrl) {
                conclusionHtml += `
                    üî¥ <strong>PROBLEMA ENCONTRADO: URLs diferentes</strong><br>
                    üí° <strong>SOLUCI√ìN:</strong> Actualizar netlify/functions/sheets-proxy.js con tu URL correcta<br>
                    üîß <strong>SIGUIENTE PASO:</strong> Cambiar la URL en el c√≥digo del proxy
                `;
            } else if (diagnosis.script_connectivity && diagnosis.missing_functions.includes('testConnection')) {
                conclusionHtml += `
                    üü° <strong>PROBLEMA PARCIAL: Script funciona pero faltan funciones</strong><br>
                    üí° <strong>SOLUCI√ìN:</strong> El script no tiene todas las funciones implementadas<br>
                    üîß <strong>SIGUIENTE PASO:</strong> Verificar que el c√≥digo completo est√© en Google Apps Script
                `;
            } else {
                conclusionHtml += `
                    üü¢ <strong>Diagn√≥stico inconcluso</strong><br>
                    üí° Necesitamos m√°s informaci√≥n para determinar el problema exacto
                `;
            }
            
            conclusionHtml += '</div>';
            conclusions.innerHTML = conclusionHtml;
        }
    </script>
</body>
</html>
