<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Asistencia Tenis - MVP</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuraci√≥n personalizada de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            200: '#a7f3d0',
                            300: '#6ee7b7',
                            400: '#34d399',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        },
                        secondary: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        },
                        accent: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Contenido principal - Se carga din√°micamente -->
    <div id="app">
        <!-- Loading inicial -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4"></div>
                <p class="text-gray-600 text-lg">Cargando Sistema de Asistencia...</p>
                <p class="text-gray-500 text-sm mt-2">Inicializando arquitectura modular...</p>
            </div>
        </div>
    </div>

    <!-- Modal para notificaciones -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <div id="notification-content">
                    <!-- Contenido del modal -->
                </div>
                <div class="mt-4 text-right">
                    <button onclick="closeNotification()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de configuraci√≥n -->
    <script>
        // Configuraci√≥n global para Google Apps Script
        window.APP_CONFIG = {
            // URL de tu Google Apps Script Web App
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyEX5_nozYOivyWX35otetoz9unvUCJI2Zqy4r1ov-6GZ6zKrF8dOKDAcONq_18-zDK/exec',
            
            // ID de tu Google Sheets
            SPREADSHEET_ID: '17V4XZMYxc9wzzlc9JWXdoZgTmxhlM8I_p9ZUYoJn7OI',
            
            // Configuraci√≥n del entorno
            ENVIRONMENT: 'development',
            DEBUG: true,
            
            // Configuraci√≥n adicional para debugging
            VERBOSE_LOGGING: true,
            LOG_API_REQUESTS: true
        };
        
        // Variable global para el estado de la aplicaci√≥n (Simplificada para MVP)
        window.AppState = {
            // Datos core
            user: null,
            isAuthenticated: false,
            grupos: [],
            estudiantes: [],
            
            // Estado actual
            currentView: 'date-selector',
            selectedDate: null,
            currentAttendance: {},
            connectionStatus: 'online',
            
            // Debug info
            debugInfo: {
                appStartTime: new Date().toISOString(),
                lastDataLoad: null,
                apiCallCount: 0,
                errors: []
            }
        };
        
        // Log inicial
        console.log('üéæ Sistema de Asistencia Tenis - MVP Modular');
        console.log('üìã Configuraci√≥n:', window.APP_CONFIG);
        console.log('üïê Iniciando:', new Date().toISOString());
    </script>

    <!-- SERVICIOS DE DATOS (Capa de datos) -->
    <script src="js/services/group-service.js" onload="console.log('‚úÖ GroupService cargado')" onerror="console.error('‚ùå Error: group-service.js')"></script>
    <script src="js/services/student-service.js" onload="console.log('‚úÖ StudentService cargado')" onerror="console.error('‚ùå Error: student-service.js')"></script>
    <script src="js/services/attendance-service.js" onload="console.log('‚úÖ AttendanceService cargado')" onerror="console.error('‚ùå Error: attendance-service.js')"></script>

    <!-- COMPONENTES DE UI (Capa de presentaci√≥n) -->
    <script src="js/components/date-selector.js" onload="console.log('‚úÖ DateSelectorView cargado')" onerror="console.error('‚ùå Error: date-selector.js')"></script>
    <script src="js/components/dashboard.js" onload="console.log('‚úÖ DashboardView cargado')" onerror="console.error('‚ùå Error: dashboard.js')"></script>
    <script src="js/components/attendance-form.js" onload="console.log('‚úÖ AttendanceFormView cargado')" onerror="console.error('‚ùå Error: attendance-form.js')"></script>
    <script src="js/components/modals.js" onload="console.log('‚úÖ ModalsView cargado')" onerror="console.error('‚ùå Error: modals.js')"></script>

    <!-- CONTROLADORES (Capa de l√≥gica de negocio) -->
    <script src="js/controllers/app-controller.js" onload="console.log('‚úÖ AppController cargado')" onerror="console.error('‚ùå Error: app-controller.js')"></script>
    <script src="js/controllers/date-controller.js" onload="console.log('‚úÖ DateController cargado')" onerror="console.error('‚ùå Error: date-controller.js')"></script>
    <script src="js/controllers/attendance-controller.js" onload="console.log('‚úÖ AttendanceController cargado')" onerror="console.error('‚ùå Error: attendance-controller.js')"></script>
    <script src="js/controllers/group-controller.js" onload="console.log('‚úÖ GroupController cargado')" onerror="console.error('‚ùå Error: group-controller.js')"></script>

    <!-- UTILIDADES Y APIs (Capa base) -->
    <script src="js/utils.js" onload="console.log('‚úÖ Utils cargado')" onerror="console.error('‚ùå Error: utils.js')"></script>
    <script src="js/sheets-api.js" onload="console.log('‚úÖ SheetsAPI cargado')" onerror="console.error('‚ùå Error: sheets-api.js')"></script>

    <!-- APLICACI√ìN PRINCIPAL (Inicializaci√≥n y routing) -->
    <script src="js/main.js" onload="console.log('‚úÖ Main (refactorizado) cargado')" onerror="console.error('‚ùå Error: main.js')"></script>

    <!-- Verificaci√≥n de dependencias e inicializaci√≥n -->
    <script>
        // Lista completa de dependencias requeridas para el MVP
        const REQUIRED_DEPENDENCIES = [
            // Utilidades base
            'DateUtils', 'DataUtils', 'UIUtils', 'StorageUtils', 'ValidationUtils',
            
            // API y servicios
            'SheetsAPI', 'GroupService', 'StudentService', 'AttendanceService',
            
            // Componentes de UI
            'DateSelectorView', 'DashboardView', 'AttendanceFormView', 'ModalsView', 'ModalsController',
            
            // Controladores
            'AppController', 'DateController', 'AttendanceController', 'GroupController',
            
            // Funciones principales
            'initApp', 'closeNotification'
        ];
        
        /**
         * Verifica que todas las dependencias est√©n cargadas
         */
        function checkMVPDependencies() {
            console.log('üîç Verificando dependencias del MVP...');
            
            const missing = REQUIRED_DEPENDENCIES.filter(dep => typeof window[dep] === 'undefined');
            
            if (missing.length > 0) {
                console.error('‚ùå Dependencias faltantes:', missing);
                
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-red-50">
                        <div class="text-center max-w-lg p-6">
                            <span class="text-6xl mb-4 block">üö®</span>
                            <h2 class="text-2xl font-bold text-red-900 mb-4">Error de Carga del MVP</h2>
                            <p class="text-red-700 mb-4">No se pudieron cargar ${missing.length} archivos necesarios:</p>
                            <div class="bg-red-100 p-4 rounded mb-6 text-left max-h-40 overflow-y-auto">
                                <ul class="text-red-600 text-sm space-y-1">
                                    ${missing.map(dep => `<li>‚Ä¢ ${dep}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="space-y-3">
                                <button onclick="location.reload()" class="btn bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700 w-full">
                                    üîÑ Recargar P√°gina
                                </button>
                                <button onclick="console.log('Dependencias:', {required: REQUIRED_DEPENDENCIES, available: REQUIRED_DEPENDENCIES.filter(d => typeof window[d] !== 'undefined')})" 
                                        class="btn bg-gray-600 text-white px-6 py-2 rounded hover:bg-gray-700 w-full text-sm">
                                    üêõ Debug en Consola
                                </button>
                            </div>
                            <div class="mt-4 text-xs text-red-500">
                                <p>Verifica que todos los archivos .js est√©n en las carpetas correctas</p>
                            </div>
                        </div>
                    </div>
                `;
                return false;
            }
            
            console.log('‚úÖ Todas las dependencias del MVP cargadas correctamente');
            console.log(`üìä Total: ${REQUIRED_DEPENDENCIES.length} m√≥dulos cargados`);
            return true;
        }
        
        /**
         * Inicializaci√≥n cuando el DOM est√© listo
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM listo - Verificando MVP...');
            
            // Verificar dependencias
            if (!checkMVPDependencies()) {
                return;
            }
            
            // Verificar configuraci√≥n cr√≠tica
            if (!window.APP_CONFIG.APPS_SCRIPT_URL || !window.APP_CONFIG.SPREADSHEET_ID) {
                console.error('‚ùå Configuraci√≥n incompleta');
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-yellow-50">
                        <div class="text-center max-w-md p-6">
                            <span class="text-6xl mb-4 block">‚öôÔ∏è</span>
                            <h2 class="text-2xl font-bold text-yellow-900 mb-4">Error de Configuraci√≥n</h2>
                            <p class="text-yellow-700 mb-6">Faltan configuraciones cr√≠ticas del sistema.</p>
                            <button onclick="location.reload()" class="btn bg-yellow-600 text-white px-6 py-3 rounded hover:bg-yellow-700">
                                üîÑ Recargar P√°gina
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Todo listo, inicializar MVP
            try {
                console.log('üéØ Iniciando MVP del Sistema de Asistencia Tenis...');
                initApp();
            } catch (error) {
                console.error('üí• Error fatal al inicializar MVP:', error);
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-red-50">
                        <div class="text-center max-w-md p-6">
                            <span class="text-6xl mb-4 block">üí•</span>
                            <h2 class="text-2xl font-bold text-red-900 mb-4">Error Fatal</h2>
                            <p class="text-red-700 mb-4">Error al inicializar el MVP:</p>
                            <div class="bg-red-100 p-3 rounded mb-6 text-left">
                                <pre class="text-red-600 text-xs">${error.message}</pre>
                            </div>
                            <div class="space-y-3">
                                <button onclick="location.reload()" class="btn bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700 w-full">
                                    üîÑ Recargar P√°gina
                                </button>
                                <button onclick="window.getAppDebugInfo && console.log('Debug Info:', getAppDebugInfo())" 
                                        class="btn bg-gray-600 text-white px-6 py-2 rounded hover:bg-gray-700 w-full text-sm">
                                    üêõ Informaci√≥n de Debug
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        // Manejo mejorado de errores
        window.addEventListener('error', function(e) {
            console.error('üî• Error de script:', e.filename, e.lineno, e.message);
            if (window.AppState?.debugInfo) {
                window.AppState.debugInfo.errors.push({
                    type: 'script_error',
                    message: e.message,
                    filename: e.filename,
                    line: e.lineno,
                    timestamp: new Date().toISOString()
                });
            }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('üö® Promise rechazada:', event.reason);
            if (window.AppState?.debugInfo) {
                window.AppState.debugInfo.errors.push({
                    type: 'unhandled_rejection',
                    reason: event.reason.toString(),
                    timestamp: new Date().toISOString()
                });
            }
        });
        
        console.log('üí° Tips para desarrollo:');
        console.log('   - getAppDebugInfo() para informaci√≥n completa');
        console.log('   - clearAppData() para limpiar datos locales');
        console.log('   - AppRouter.navigateTo(view, params) para navegaci√≥n manual');
    </script>
</body>
</html>
